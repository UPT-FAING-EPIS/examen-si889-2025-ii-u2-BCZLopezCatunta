name: ğŸš€ Publish Version and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  compile:
    name: ğŸ”¨ 1. Compilar aplicaciÃ³n
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
      
    - name: â˜• Configurar Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ğŸ—ï¸ Compilar aplicaciÃ³n
      run: |
        echo "=== COMPILANDO APLICACIÃ“N ==="
        mvn clean compile -B
        echo "âœ… CompilaciÃ³n EXITOSA"

  unit-tests:
    name: ğŸ§ª 2. Ejecutar tests unitarios
    runs-on: ubuntu-latest
    needs: compile
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
      
    - name: â˜• Configurar Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ğŸ§ª Ejecutar tests
      run: |
        echo "=== EJECUTANDO TESTS UNITARIOS ==="
        mvn test -B
        echo "âœ… Tests unitarios COMPLETADOS"

  test-coverage:
    name: ğŸ“Š 3. Reporte de cobertura
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
      
    - name: â˜• Configurar Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ğŸ“ˆ Generar reporte de cobertura
      run: |
        echo "=== GENERANDO REPORTE DE COBERTURA ==="
        mvn clean test jacoco:report -B
        echo "âœ… Reporte de cobertura GENERADO"
        
    - name: ğŸ“ Verificar archivos generados
      run: |
        echo "=== ARCHIVOS DE COBERTURA ==="
        ls -la target/site/jacoco/
        
    - name: ğŸš€ Subir para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: target/site/jacoco/

  deploy-to-pages:
    name: ğŸŒ 4. Publicar en GitHub Pages
    runs-on: ubuntu-latest
    needs: test-coverage
    permissions:
      pages: write
      id-token: write
      contents: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸš€ Desplegar en GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  create-release:
    name: ğŸ·ï¸ 5. Publicar Release
    runs-on: ubuntu-latest
    needs: [compile, unit-tests, test-coverage]
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Crear Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: "Release v${{ github.ref_name }}"
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ‰ Release AutomÃ¡tico Examen SI889
          
          **Estudiante:** BCZLopezCatunta
          **Fecha:** ${{ github.event.head_commit.timestamp }}
          
          ### âœ… Procesos Completados:
          
          1. ğŸ”¨ **CompilaciÃ³n** - CÃ³digo compilado exitosamente
          2. ğŸ§ª **Tests Unitarios** - Todos los tests ejecutados y pasados
          3. ğŸ“Š **Cobertura de CÃ³digo** - Reporte JaCoCo generado
          4. ğŸŒ **GitHub Pages** - Reporte publicado online
          5. ğŸ·ï¸ **Release** - VersiÃ³n publicada automÃ¡ticamente
          
          ### ğŸ“ˆ Reporte de Cobertura:
          Disponible en: https://upt-faing-epis.github.io/examen-si889-2025-ii-u2-BCZLopezCatunta/
          
          ---
          *AutomÃ¡ticamente generado por GitHub Actions CI/CD*